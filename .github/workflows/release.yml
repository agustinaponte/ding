name: Release (tags)


on:
push:
tags:
- 'v*.*.*'


jobs:
build-windows:
runs-on: windows-latest
env:
PYTHON_VERSION: '3.12'


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Set up Python
uses: actions/setup-python@v4
with:
python-version: ${{ env.PYTHON_VERSION }}


- name: Install build deps
run: |
python -m pip install --upgrade pip
pip install -r requirements.txt


- name: Determine version from tag
id: ver
run: |
echo "::set-output name=tag::${GITHUB_REF#refs/tags/}"
echo "Tag is ${GITHUB_REF#refs/tags/}"


- name: Run PyInstaller
run: |
pyinstaller ding.spec


- name: Prepare artifacts folder
run: |
mkdir artifacts
copy dist\ding.exe artifacts\ding-${{ steps.ver.outputs.tag }}.exe


- name: Build MSI (msicreator)
shell: powershell
run: |
# create an MSICreator project file (pcreate) and build it (pbuild)
# Publisher: agustinaponte
pcreate -n "Ding" -v $env:GITHUB_REF_NAME -a "agustinaponte" -m "artifacts\ding-${{ steps.ver.outputs.tag }}.exe" -o msibld
pbuild msibld
# pbuild will emit an .msi file in msibld\dist - move it to artifacts
Get-ChildItem msibld\dist -Filter *.msi | ForEach-Object { Copy-Item $_.FullName -Destination ("artifacts\" + $_.Name) }


- name: List artifacts
run: dir artifacts


- name: Create GitHub Release
uses: softprops/action-gh-release@v1
with:
tag_name: ${{ steps.ver.outputs.tag }}
env:
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


- name: Upload Release Assets
uses: softprops/action-gh-release@v1
with:
files: artifacts/*
env:
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}